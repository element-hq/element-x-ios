name: Build alpha release

on:

  # Triggers the workflow on any pull request
  pull_request:

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build:
    # Don't run for forks as secrets are unavailable.
    if: github.repository == 'vector-im/element-x-ios'
    name: Release
    runs-on: macos-12
    
    concurrency:
      # Only allow a single run of this workflow on each branch, automatically cancelling older runs.
      group: alpha-${{ github.head_ref }}
      cancel-in-progress: true

    steps:
      - uses: actions/checkout@v3

      - name: Cache Ruby gems
        uses: actions/cache@v3
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-gems-

      # Common setup
      - name: Brew bundle
        run:
          brew bundle

      - name: Bundle install
        run: |
          bundle config path vendor/bundle
          bundle install --jobs 4 --retry 3

      - uses: actions/setup-python@v3
        with:
          python-version: '3.x'
          cache: 'pip'
          
      - run: pip install -r requirements.txt
      
      # Import alpha release private signing certificate
      - name: Import signing certificate
        uses: apple-actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.ALPHA_CERTIFICATES_P12 }}
          p12-password: ${{ secrets.ALPHA_CERTIFICATES_P12_PASSWORD }}

      # Main step
      # The Ad-hoc release link will be referenced as 'DIAWI_FILE_LINK'
      # and QR link as 'DIAWI_QR_CODE_LINK' when the Diawi upload succeed
      - name: Build alpha
        run: bundle exec fastlane alpha
        env:
          # Automatically bypass 2FA upgrade if possible on Apple account.
          SPACESHIP_SKIP_2FA_UPGRADE: true
          APPLE_ID: ${{ secrets.FASTLANE_USER }}
          FASTLANE_USER: ${{ secrets.FASTLANE_USER }}
          FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
          DIAWI_API_TOKEN: ${{ secrets.DIAWI_API_TOKEN }}
          GITHUB_PR_NUMBER: ${{ github.event.number }}

      - name: Add release notes and Diawi info
        uses: NejcZdovc/comment-pr@v1
        with:
          message: |
            :iphone: Scan the QR code below to install the build for this PR. 
            :lock: This build is for internal testing purpose. Only devices listed in the ad-hoc provisioning profile can install Element Alpha.  

            ![QR code](${{ env.DIAWI_QR_CODE_LINK }})  

            If you can't scan the QR code you can install the build via this link: ${{ env.DIAWI_FILE_LINK }}
          # Enables to identify and update existing Ad-hoc release message on new commit in the PR
          identifier: "GITHUB_COMMENT_ADHOC_RELEASE"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
