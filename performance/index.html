<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@^3"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@^2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@^1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>
    <title>element-x-ios perf</title>
  </head>
  <body>
    <h1>Performance metrics from element-x-ios nightly integration runs</h2>
    <div>Also see the <a href="./perf-data.csv">raw data</a>. Be aware these are not absolute timings, the performance of the github runner will affect the time. Compare them as a relative action only.</div>
    <div>Metrics are gathered based on signposts in the iOS code, while the app is being controlled automatically. The flows are repeated 5 times and the min/median/max presented here. Time for automation to complete is not included in these timings - they hook into the backends of the app where appropriate.</div>
    <table>
      <tr>
        <td><h2>Launch time(s)</h2></td>
        <td><h2>Login time(s)</h2></td>
        <td><h2>First Sync time(s)</h2></td>
        <td><h2>First Rooms time(s)</h2></td>
        <td><h2>Roomflow time(s) [1]</h2></td>
      </tr>
      <tr>
        <td><canvas id="launchPerformance"/></td>
        <td><canvas id="loginPerformance"/></td>
        <td><canvas id="firstSyncPerformance"/></td>
        <td><canvas id="firstRoomsPerformance"/></td>
        <td><canvas id="roomFlowPerformance"/></td>
      </tr>
      <tr>
        <td><small>Time to start app to first paint</small></td>
        <td><small>Time from submitting user/pass form to completing all pre-sync tasks</small></td>
        <td><small>Time for first sync request to finish</small></td>
        <td><small>Time from the app start to a populated room list</small></td>
        <td><small>Time from click on first room in list to seeing contents of room.</small></td>

      </tr>
     </table>
     <div>[1] We're not confident that this is measuring a valid flow at present, it should probably not be taking ~21s to complete. Please disreguard for now</div>
  <script>
  d3.csv('./perf-data.csv').then(makeCharts);
  
  function floatify(perfdata) {
    return perfdata.map(
      function(d) {
        d.Data1 = parseFloat(d.Data1);
        d.Data2 = parseFloat(d.Data2);
        d.Data3 = parseFloat(d.Data3);
        d.Data4 = parseFloat(d.Data4);
        d.Data5 = parseFloat(d.Data5);
        return d
      }
    );
  }
    
  function makeCharts(stringdata) { 
    var perfdata = floatify(stringdata);
    var launchPerformance = perfdata.filter(function (d) { return d.Test == "launchPerformance"  });
    makeChart(launchPerformance,"launchPerformance")
    var loginPerformance = perfdata.filter(function (d) { return d.Test == "loginPerformance"  });
    makeChart(loginPerformance,"loginPerformance")
    var firstSyncPerformance = perfdata.filter(function (d) { return d.Test == "firstSyncPerformance"  });
    makeChart(firstSyncPerformance,"firstSyncPerformance")
    var firstRoomsPerformance = perfdata.filter(function (d) { return d.Test == "firstRoomsPerformance"  });
    makeChart(firstRoomsPerformance,"firstRoomsPerformance")
    var roomFlowPerformance = perfdata.filter(function (d) { return d.Test == "roomFlowPerformance"  });
    makeChart(roomFlowPerformance,"roomFlowPerformance")
  }
    
  function makeChart(perfdata, canvas_id) {
    console.log(perfdata);
    var maxData = perfdata.map(
      function(d) { return { x: d.Date, y: Math.max(d.Data1, d.Data2, d.Data3, d.Data4, d.Data5) } });
    var minData = perfdata.map(
      function(d) { return { x: d.Date, y: Math.min(d.Data1, d.Data2, d.Data3, d.Data4, d.Data5) } });
    var medianData = perfdata.map(
      function(d) {
        let values = [d.Data1, d.Data2, d.Data3, d.Data4, d.Data5];
        values.sort(function(a,b) { return a - b });
        return { x: d.Date, y: values[2] };
      }
    );

    var avgData = perfdata.map(
      function(d) {
        return {
          x: d.Date,
          y: (d.Data1 + d.Data2 + d.Data3 + d.Data4 + d.Data5)/5
        }
      }
    );
    var chart = new Chart(canvas_id, {
      type: 'line',
      data: {
        datasets: [
          {
            label: "min",
            data: minData,
            fill: "+1",
            borderColor: "#CCFFCC"
          },
          {
            label: "median",
            data: medianData,
            borderColor: "#CCCCFF"
          },
          {
            label: "max",
            data: maxData,
            fill: "-1",
            borderColor: "#FFCCCC"
          }
        ]
      },
      options: {
        interaction: {
          intersect: false,
          mode: 'index', 
        },
        scales: {
          x: {
            type: 'time',
            title: "Test run date",
            display: "true",
            time: {
            }
          },
          y: {
            display: "true",
            title: "Duration" 
          }
        }
      }
    });
  }
  </script>
  </body>

</html>
  
    
